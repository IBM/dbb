def JenkinsAgent              = "ztec-201-STC"
def pipeverbose               = true

pipeline {
    agent { label JenkinsAgent }

    environment {
        GIT_STRATEGY = "none"
        GIT_CHECKOUT = "false"
        wdEnvironmentFile = "EOLEB7-${application}-${targetEnvironment.capitalize()}.yaml" //Make sure the referenced file matches the required naming convention
        wdEvidencePath = "deploy/evidences"
        wdEvidencesRoot = "/var/work/wazi_deploy_evidences_jenkins/"
        wdEvidencesIndex = "/var/work/wazi_deploy_evidences_jenkins_index/"
        uniqueWorkspaceId = "${WORKSPACE}/${application}/deploy-${buildId}"
        deployOutputDirectory = "${WORKSPACE}/${application}/DEPLOY-OUTPUT"
    }

    parameters {
        string(name: 'application', defaultValue: '', description: 'Application name (e.g., retirementCalculator, MortgageApplication)')
        choice(name: 'PackageType', choices: ['build', 'release'], description: 'Package type: a preliminary build or release candidate')
        string(name: 'buildId', defaultValue: '', description: 'Build pipeline ID (e.g., 00000018)')
        string(name: 'packageReference', defaultValue: '', description: 'Release version( release pipeline, eg:release eg: rel-1.6.1 ) or branch name( for build pipeline, eg: main, feature) ')
        choice(name: 'targetEnvironment', choices: ['integration', 'acceptance', 'production'], description: 'Deployment target environment')
        
    }
    
    options {
        disableConcurrentBuilds()
        timestamps()
    }

    stages {
        stage('Validate Parameters') {
            steps {
                script {
                    echo "==============================="
                    echo "Deployment Pipeline Parameters"
                    echo "==============================="
                    echo "[INFO] Application: ${application}"
                    echo "[INFO] Package Type: ${PackageType}"
                    echo "[INFO] Build ID: ${buildId}"
                    echo "[INFO] Release Version: ${packageReference}"
                    echo "[INFO] Target Environment: ${targetEnvironment}"
                    echo "[INFO] Workspace: ${uniqueWorkspaceId}"
                    echo "==============================="
                    
                    def errors = []
                    if (!application) errors << "application is required"
                    if (!buildId) errors << "buildId is required"
                    if (errors) {
                        errors.each { echo "[ERROR] ${it}" }
                        error("[ERROR] Validation failed. Please fix input errors.")
                    }
                    echo "[SUCCESS] All validations passed"
                }
            }
        }

        stage('Generate Plan') {
            steps {
                script {

                    echo "[INFO] Generating deployment plan for ${targetEnvironment}"
                    echo "[INFO] Package type: ${PackageType}"

                    def CMD = ""

                    CMD = "wazideploy-generate.sh -w ${uniqueWorkspaceId} -a ${application} -P ${packageType} -R ${packageReference} -I ${buildId}"

                    echo "[INFO] Executing command: ${CMD}"

                    def rc = sh(script: CMD, returnStatus: true)

                    if (rc == 0) {
                        echo "[INFO]: Plan generation passed (RC=0)"
                    } else {
                        echo "[ERROR]: Plan generation failed (RC=${rc})"
                    }
                }
            }
        }

        stage('Deploy') {
            steps {
                script {
                    echo "[INFO] Deploying to ${targetEnvironment} environment"
                    echo "[INFO] Using environment file: ${wdEnvironmentFile}"
                    echo "[INFO] Evidence path: ${wdEvidencePath}"
                    def CMD = ""
                    CMD = "wazideploy-deploy.sh -w ${uniqueWorkspaceId} -e ${wdEnvironmentFile} -l ${wdEvidencePath}/evidence.yaml < /dev/null" 
                    echo "[INFO] Executing command: ${CMD}"   

                    def rc = sh(script: CMD, returnStatus: true)

                    if (rc == 0) {
                        echo "[INFO]: Deployment passed. (RC=0)"
                    } else {
                        echo "[ERROR]: Deployment failed. (RC=${rc})"
                    }
                }
            }
        }

        stage('Report') {
            steps {
                script {

                    def reportDir = "${deployOutputDirectory}/deploy-${targetEnvironment}"
                    def sourceEvidenceFile = "${uniqueWorkspaceId}/deployPkgDir/deploy/evidences/evidence.yaml"
                    def wdEvidencesDir = "${wdEvidencesRoot}/${application}/${targetEnvironment}"
                    def wdEvidencesIndex = "${wdEvidencesIndex}"

                    echo "[INFO] Generating deployment report for ${targetEnvironment}"
                    def evidenceCmd = ""
                    evidenceCmd = "wazideploy-evidence.sh -w ${uniqueWorkspaceId} -l ${wdEvidencePath}/evidence.yaml -o deploy/deployment-report.html" 
                    echo "[INFO] Executing command: ${evidenceCmd}" 
                    sh evidenceCmd
                    
                    sh "mkdir -p ${deployOutputDirectory}"
                    sh "mkdir -p ${reportDir}"
                    echo "[INFO] Using report directory: ${reportDir}"

                    // Persist evidence
                    sh "mkdir -p ${wdEvidencesDir} && mkdir -p ${wdEvidencesIndex}"
                    sh "cp ${sourceEvidenceFile} ${wdEvidencesDir}/evidence-${buildId}.yaml"
                    echo "[INFO] Persisted evidence file at ${wdEvidencesDir}"

                    // Update Wazi Deploy index

                    def indexCmd = ""

                    indexCmd = "wazideploy-evidence --index ${wdEvidencesIndex} --dataFolder ${wdEvidencesRoot} i"
                    
                    echo "[INFO] Executing command: ${indexCmd}" 

                    def rc = sh(script: indexCmd, returnStatus: true)

                    if (rc == 0) {
                        echo "[INFO]: Deployment report generated. (RC=0)"
                    } else {
                        echo "[ERROR]: Deployment report generation failed. (RC=${rc})"
                    }
                sourceEvidenceFilePath = "${uniqueWorkspaceId}/deployPkgDir/deploy/evidences"

                }
            }
            post {
				always {
					// Pick up files created by the deployment.
					 dir ("${sourceEvidenceFilePath}") {
					 	archiveArtifacts allowEmptyArchive: true,
					 		artifacts: '*.yml,*.yaml',
					 		excludes: '*clist',
					 		onlyIfSuccessful: false
					 }
					 dir ("${WORKSPACE}/deployPkgDir/deploy") {
					 	archiveArtifacts allowEmptyArchive: true,
					 		artifacts: '*.html',
					 		excludes: '*clist',
					 		onlyIfSuccessful: false
					 }
				}
			}
        }

		stage ('Workspace Cleanup') {
			steps {
				script {
					if (pipeverbose) {
						println("[DEBUG]: Final Cleanup before deletes.")

						dir("${WORKSPACE}") {
							sh "pwd ; ls -al"
						}
					}
					
					if (pipeverbose) {
						println("[DEBUG]: Final Cleanup after deletes.")

						dir("${WORKSPACE}") {
							sh "pwd ; ls -al"
						}
					}
				}
			}
			post {
			// Clean after build
				always {
					cleanWs(cleanWhenNotBuilt: false,
							deleteDirs: true,
							disableDeferredWipeout: true,
							notFailBuild: true)
				}
			}

		} 
    }
}
