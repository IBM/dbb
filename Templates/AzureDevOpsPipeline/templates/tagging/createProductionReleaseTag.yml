parameters:
  - name: environmentName
    type: string
    default: "." # defaults for any parameters that specified with "." (current directory)

# Template to compute and create the release tag
steps:
  - checkout: none
  - bash: |

      # If release type is defined
      if [ ! -z "$(releaseType)" ]; then

      # Obtain latest release candidate tag

      previousTag=$(az repos ref list --org $(System.CollectionUri) --project $(System.TeamProjectId) -r $(application) --filter tags --query '[?name].name | sort(@)[-1]')
      # echo Old Tag = ${previousTag} # Debug

      # case of a new release candidate for the current release
      if [[ "${previousTag}" == *"rc"* ]]; then
        # echo "bump release candidate version" # Debug
        export productionTag=`echo $previousTag | sed 's/^["refs\/tags\/rel-]*//g' | awk -F "_rc" '{print "rel-"$1}' | tr -d \"  ` 
      else
        echo "[ERROR] Previous Tag is not a release candidate. Cannot set Production Tag"
      fi

      # Create new tag
      echo "[INFO] Creating Tag ${productionTag} as latest production state."
      az rest \
         --method post \
         --headers "Authorization=Bearer $AZURE_DEVOPS_EXT_PAT" \
         --url $(System.CollectionUri)/$(System.TeamProjectId)/_apis/git/repositories/$(application)/annotatedtags\?api-version\=7.1-preview.1 \
         --body "{ \"name\": \"${productionTag}\",  \"taggedObject\": { \"objectId\": \"$(Build.SourceVersion)\" }, \"message\": \"Release Candidate created by pipeline $(Build.BuildNumber) \"} " \
         --resource 499b84ac-1321-427f-aa17-267ca6975798
      # catch RC rest command return code
      rc=$?

      if [ $rc -eq 0 ]; then
        echo "[INFO] - AZ REST command has completed successfully."
      else
        echo "[WARNING] - AZ REST command has ended with a return code other than 0. rc="$rc
        exit rc
      fi

      else
        echo "[WARNING] - No release type has been specified"
        exit 1
      fi
    
    condition :  ${{ eq(parameters.environmentName, 'Production') }}
    env:
      AZURE_DEVOPS_EXT_PAT: $(System.AccessToken)
    displayName: "Create Release Tag"
